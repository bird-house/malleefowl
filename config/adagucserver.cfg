[buildout]
parts += 
      adagucserver_conda
      adagucserver_app
      adagucserver_config
      adagucserver_postgres
      postgres_config
      postgres_supervisor
      adagucserver_gunicorn
      adagucserver_supervisor
      adagucserver_nginx

[adagucserver_conda]
recipe = birdhousebuilder.recipe.conda
pkgs = 
     adagucserver
     postgresql

[adagucserver_app]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/adagucserver.py
output = ${buildout:anaconda-home}/etc/adagucserver/adagucserver.py

prefix = ${buildout:anaconda-home}

[adagucserver_config]
recipe = collective.recipe.template[genshi]:genshi
input = ${buildout:directory}/templates/autowms.xml
output = ${buildout:anaconda-home}/etc/adagucserver/autowms.xml

prefix = ${buildout:anaconda-home}
online_resource = http://${settings:hostname}:${settings:adagucserver-port}/?
font = ${buildout:anaconda-home}/share/adagucserver/fonts/FreeSans.ttf
db_params = dbname=adaguc host=127.0.0.1 port=${settings:postgres-port} user=adaguc password=
data_dir = ${buildout:anaconda-home}/var/cache/pywps

[adagucserver_postgres]
recipe = makina.recipe.postgres
bin = ${buildout:anaconda-home}/bin
initdb = --auth=trust --pgdata=${buildout:anaconda-home}/var/lib/postgres
pgdata = ${buildout:anaconda-home}/var/lib/postgres
cmds =
     createuser -p ${settings:postgres-port} --createdb --no-createrole --no-superuser --login adaguc
     createdb -p ${settings:postgres-port} --owner=adaguc adaguc
     createdb -p ${settings:postgres-port}

[postgres_config]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/postgresql.conf
output = ${buildout:anaconda-home}/var/lib/postgres/postgresql.conf

port = ${settings:postgres-port}

[postgres_supervisor]
recipe = birdhousebuilder.recipe.supervisor

program = postgres
command = ${buildout:anaconda-home}/bin/postgres -D ${buildout:anaconda-home}/var/lib/postgres
directory = ${buildout:anaconda-home}/var/lib/postgres

[adagucserver_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py
output = ${buildout:anaconda-home}/etc/adagucserver/gunicorn.conf.py

prefix = ${buildout:anaconda-home}

[adagucserver_supervisor]
recipe = birdhousebuilder.recipe.supervisor

program = adagucserver
command = ${buildout:anaconda-home}/bin/gunicorn adagucserver:app -c ${adagucserver_gunicorn:output}
directory = ${buildout:anaconda-home}/etc/adagucserver

[adagucserver_nginx]
recipe = birdhousebuilder.recipe.nginx
input = ${buildout:directory}/templates/nginx.conf
sites = adagucserver

hostname =  ${settings:hostname}
port = ${settings:adagucserver-port}


