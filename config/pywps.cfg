[pywps_build]

parts = 
    htmltmpl
    pywps_checkout
    PyWPS   
    pywps
    pywps_python
    pywps_config
    pywps_logrotate
    pywps_gunicorn
    pywps_supervisor
    pywps_deploy

[htmltmpl]
recipe = z3c.recipe.scripts
find-links = http://sourceforge.net/projects/htmltmpl/files/htmltmpl/1.22/htmltmpl-1.22.tar.gz/download#egg=htmltmpl-1.22
eggs = htmltmpl

[pywps_checkout]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
     target=${buildout:directory}/src/PyWPS
     address=https://github.com/cehbrecht/PyWPS.git
     branch=master
     if [ -d $target ] 
        then 
            cd $target
            git pull
            cd -
        else
            git clone $address $target -b $branch
     fi

[PyWPS]
recipe = zc.recipe.egg:develop
setup = ${buildout:directory}/src/PyWPS/setup.py

[pywps]
recipe = z3c.recipe.scripts
eggs =
    PyWPS
    lxml
    htmltmpl
    python-magic
    ordereddict
home = ${install:prefix}/var/lib/pywps
socket = ${install:prefix}/var/run/pywps/pywps.socket
log_file = ${install:prefix}/var/log/pywps/pywps.log

[pywps_python]
recipe = z3c.recipe.scripts
eggs =
    ${pywps:eggs} 
    ${malleefowl:eggs}
interpreter = python

[pywps_config]  
recipe = collective.recipe.template
input = ${buildout:directory}/templates/pywps.cfg.in
output = ${buildout:directory}/etc/pywps.cfg

processes_path = ${buildout:directory}/processes
output_path = ${pywps:home}/outputs
temp_path = ${pywps:home}/temp
cache_path = ${pywps:home}/cache
log_path = ${install:prefix}/var/log/pywps
files_path = ${pywps:home}/files
files_url = http://${server:hostname}:${ports:http}/files
malleefowl_path = ${buildout:directory}

[pywps_logrotate]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/logrotate.in
output = ${buildout:parts-directory}/pywps/logrotate

log_file=${pywps:log_file}

[pywps_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py.in
output = ${buildout:directory}/etc/gunicorn.conf.py

bind = unix://${pywps:socket}

[pywps_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf.in
output = ${buildout:parts-directory}/pywps/supervisor.conf

program = pywps
command = ${buildout:bin-directory}/python ${buildout:bin-directory}/gunicorn wsgiwps:application -c ${buildout:directory}/etc/gunicorn.conf.py
directory = ${buildout:directory}/src/PyWPS/webservices/wsgi
priority = 20

[pywps_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    sudo mkdir -p ${install:prefix}/var/run/pywps
    sudo chown -R ${install:user}.${install:group} ${install:prefix}/var/run/pywps
    sudo mkdir -p ${install:prefix}/var/log/pywps      
    sudo chown -R ${install:user}.${install:group} ${install:prefix}/var/log/pywps
    sudo cp ${pywps_logrotate:output} /etc/logrotate.d/pywps
    sudo cp ${pywps_supervisor:output} /etc/supervisor/conf.d/pywps.conf    
   

