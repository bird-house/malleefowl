[pywps_build]

parts = 
    pywps
    pywps_python
    pywps_config
    pywps_logrotate
    pywps_gunicorn
    pywps_supervisor
    pywps_deploy

[pywps]
recipe = z3c.recipe.scripts
eggs =
    PyWPS
    lxml
    htmltmpl
    python-magic
    ordereddict
home = ${install:prefix}/var/lib/pywps
cfg = ${install:prefix}/etc/pywps.cfg
server = unix:${install:prefix}/var/run/pywps.socket
log_file = ${install:prefix}/var/log/pywps.log

[pywps_python]
recipe = z3c.recipe.scripts
eggs =
    ${pywps:eggs} 
    ${malleefowl:eggs}
interpreter = python

[pywps_config]  
recipe = collective.recipe.template
input = ${buildout:directory}/templates/pywps.cfg.in
output = ${buildout:parts-directory}/pywps/pywps.cfg

processes_path = ${buildout:directory}/processes
output_path = ${pywps:home}/outputs
temp_path = ${pywps:home}/temp
cache_path = ${pywps:home}/cache
log_path = ${install:prefix}/var/log
files_path = ${pywps:home}/files
files_url = http://${server:hostname}:${ports:http}/files
malleefowl_path = ${buildout:directory}

[pywps_logrotate]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/logrotate.in
output = ${buildout:parts-directory}/pywps/logrotate

log_file=${pywps:log_file}

[pywps_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py.in
output = ${buildout:parts-directory}/pywps/gunicorn.conf.py

bind = ${pywps:server}

[pywps_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf.in
output = ${buildout:parts-directory}/pywps/supervisor.conf

program = pywps
command = ${buildout:bin-directory}/python ${buildout:bin-directory}/gunicorn wsgiwps:application -c ${install:prefix}/etc/gunicorn_pywps.conf.py
directory = ${buildout:directory}/src/PyWPS/webservices/wsgi
priority = 20

[pywps_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    sudo cp ${pywps_config:output} ${pywps:cfg}
    sudo cp ${pywps_gunicorn:output} ${install:prefix}/etc/gunicorn_pywps.conf.py
    sudo cp ${pywps_logrotate:output} /etc/logrotate.d/pywps
    sudo cp ${pywps_supervisor:output} /etc/supervisor/conf.d/pywps.conf    
   

